<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Play Fish! Play the popular card game Canadian Fish, also called Literature, online with friends.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playfish</title>

  <!-- PWA / icons -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Play Fish">
  <link rel="icon" sizes="192x192" href="images/touch/chrome-touch-icon-192x192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Play Fish">
  <link rel="apple-touch-icon" sizes="180x180" href="images/touch/apple-touch-icon.png">
  <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
  <meta name="msapplication-TileColor" content="#0f172a">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <meta name="theme-color" content="#0f172a">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="styles/main.css">

  <!-- Sortable.js for declare drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116900375-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-116900375-1');
  </script>
</head>

<body>

<!-- ============================================================
     LANDING SCREEN
============================================================ -->
<div id="screen-landing" class="screen active">

  <div class="landing-hero">
    <div class="landing-logo">
      <img src="images/touch/chrome-touch-icon-192x192.png" alt="Playfish">
    </div>
    <h1>Playfish</h1>
    <p>Canadian Fish &nbsp;¬∑&nbsp; Literature &nbsp;¬∑&nbsp; 6 players</p>
  </div>

  <div class="landing-main">
    <!-- Shown when page is loaded with ?gamecode= URL param -->
    <div id="gamecode-banner" class="gamecode-banner" style="display:none">
      <span class="gamecode-banner-icon">üÉè</span>
      <div class="gamecode-banner-text">
        You were invited to a game!
        <strong id="banner-code"></strong>
      </div>
      <div class="gamecode-banner-actions">
        <button class="btn btn-primary btn-sm" onclick="joinFromBanner()">Join Game</button>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('gamecode-banner').style.display='none'">Dismiss</button>
      </div>
    </div>

    <div class="landing-actions">
      <div class="action-card" onclick="showScreen('host')">
        <div class="action-card-icon">üé≤</div>
        <div class="action-card-title">Host a Game</div>
        <div class="action-card-desc">Create a new room &amp; share the code</div>
      </div>
      <div class="action-card" onclick="showScreen('join')">
        <div class="action-card-icon">üÉè</div>
        <div class="action-card-title">Join a Game</div>
        <div class="action-card-desc">Enter a code or use a shared link</div>
      </div>
    </div>
  </div>

  <!-- Instructions + randomizer -->
  <div class="instructions-outer">
    <div class="instructions-heading">About the Game</div>

    <details>
      <summary>What's Fish?</summary>
      <div class="details-body">
        <ul>
          <li>Fish (Canadian Fish, Literature, or Recollection) is a 6 player card game played in two teams of three. Each team aims to score as many half-sets as possible.</li>
          <br>
          <li>54 cards and 9 half-sets</li>
          <li>The high sets: 9‚ÄìA of each suit</li>
          <li>The low sets: 2‚Äì7 of each suit</li>
          <li>The jokers set: the four 8s and the two jokers</li>
          <br>
          <li>When it is your turn: ask a member of the opposing team for a card. You can only ask for a card if you hold a card in that half-set.</li>
          <li>If you're right: you take the card from the other player. It's your turn again.</li>
          <li>If you're wrong: it's the other player's turn.</li>
          <br>
          <li>A player can declare at any point in the game if they think their team has all six cards of a set. This is the only way to score a point.</li>
          <li>One player from the team must state exactly who on their team has which card. If they are right, they get one point. Otherwise, the other team gets the point.</li>
          <br>
          <li>This website aims to accommodate as many variations of the game as possible.</li>
          <li>In some variations, players are not allowed to bluff by asking for cards they already have. This form of bluffing is allowed on this website.</li>
          <li>Sometimes, a player may declare when it is their turn and run out of cards. The play then transfers to one of their teammates. This website allows the player to transfer to any teammate.</li>
          <li>In one variation, a player can transfer their turn to a teammate after declaring a set. This website allows players to transfer their turn to a teammate whenever they want (as long as it is their turn) to allow for all possible house rules.</li>
          <br>
          <li>A more detailed overview is available on <a href="https://en.wikipedia.org/wiki/Literature_(card_game)" target="_blank" rel="noopener">Wikipedia</a>.</li>
        </ul>
      </div>
    </details>

    <details>
      <summary>How do I use this website?</summary>
      <div class="details-body">
        <ul>
          <h3>Setting up</h3>
          <li><b>Gather your party:</b> Get 5 friends to play the game. Hardest part of the game. It is too easy to cheat in online Fish to be able to trust strangers, so this website does not have a lobby system.</li>
          <li><b>Get a code:</b> Click "Host a Game" and complete the reCAPTCHA. Then send the code or the shareable link to your friends.</li>
          <li><b>Assign numbers:</b> Give each player a number 1‚Äì6. The game is odd players (1,3,5) versus even players (2,4,6). Player 1 always goes first. Use the RNG tool below for random team assignment.</li>
          <li><b>Joining a game:</b> Click "Join a Game" or click a shared link. You can also spectate games and leave games (so someone else can hop in). Screen name is optional for spectators. When a spectator watches a player, the player is notified and their screen name is revealed.</li>
          <li><b>Playing the game:</b> After joining, the game view opens automatically.</li>

          <h3>Playing the game</h3>
          <li><b>Top bar:</b> Displays the game code (click to copy the share link), your player number, and the game score.</li>
          <li><b>Players row:</b> Shows how many cards each player has. The current player is highlighted.</li>
          <li><b>Card list:</b> Shows your cards. Click "Expand / Compact" to toggle the view.</li>
          <li><b>Log:</b> Shows the last ask.</li>
          <li><b>Declare Alert:</b> Quickly tell players you are about to declare. Non-binding, please don't spam.</li>
          <li><b>Asking for cards:</b> Click the Ask tab. First select the opponent you want to ask. Then click one of your cards to choose a set. Then click the exact card you want to ask for.</li>
          <li><b>Declaring:</b> Click the Declare tab. Select which set, then drag each card chip into the correct player's column. Click "Submit Declaration" when done.</li>
          <li><b>Transferring:</b> Click the Transfer tab. Click a teammate's name to pass your turn to them.</li>
        </ul>
      </div>
    </details>

    <details>
      <summary>Help / FAQ</summary>
      <div class="details-body">
        <h5>Nothing is working!</h5>
        <ul>
          <li>This website was tested on Chrome, Firefox, and Opera.</li>
          <li>Make sure you have no other Play Fish tabs open.</li>
          <li>If it breaks on Safari (desktop), try using Chrome.</li>
          <li>Try clearing the cache and reloading.</li>
          <li>If all else fails, use incognito.</li>
        </ul>
        <h5>I'm not near my laptop right now!</h5>
        <ul><li>This website works well on phones too.</li></ul>
        <h5>I accidentally closed the tab!</h5>
        <ul><li>Use the shared link or re-enter the game code to rejoin. You can rejoin your same player slot as long as the game is still running.</li></ul>
        <h5>I can't join the game!</h5>
        <ul><li>You're probably already in it. The server should let you back in to the same slot.</li></ul>
        <h5>Game chat is not working!</h5>
        <ul>
          <li>You must join a game to use the game chat; it is not a global chat.</li>
          <li>Currently, only players (not spectators) can use the game chat.</li>
          <li>The game chat is a last resort ‚Äî use video or voice chat instead.</li>
        </ul>
      </div>
    </details>

    <!-- Randomizer -->
    <div class="randomizer-section">
      <h3>üé≤ Team Randomizer</h3>
      <div class="randomizer-grid">
        <input type="text" id="randomize1" placeholder="Player 1">
        <input type="text" id="randomize2" placeholder="Player 2">
        <input type="text" id="randomize3" placeholder="Player 3">
        <input type="text" id="randomize4" placeholder="Player 4">
        <input type="text" id="randomize5" placeholder="Player 5">
        <input type="text" id="randomize6" placeholder="Player 6">
      </div>
      <button class="btn btn-secondary btn-sm" onclick="randomize()">Randomize</button>
    </div>
  </div>

</div><!-- /screen-landing -->


<!-- ============================================================
     HOST SCREEN
============================================================ -->
<div id="screen-host" class="screen">
  <div class="sub-screen">
    <div class="sub-screen-header">
      <button class="btn btn-ghost btn-sm" onclick="showScreen('landing')">‚Üê Back</button>
      <h2>Host a Game</h2>
    </div>

    <form id="captcha" action="/create" method="post">
      <div class="g-recaptcha" data-sitekey="6LdWWXwUAAAAAOmiqh2HaPS01fSp2xC3aY5lwHfY"></div>
      <button class="btn btn-primary btn-lg" type="submit">Create Game</button>
      <!-- hidden code field (read by host.js) -->
      <input type="text" id="code" style="display:none">
    </form>

    <div id="host-result" style="display:none">
      <div class="result-box">
        <div class="result-box-title">‚úì Game created!</div>
        <div class="code-display">
          <code id="code-display"></code>
          <button class="btn btn-ghost btn-sm" onclick="copyCode()">Copy Code</button>
        </div>
        <div class="link-display">
          <input type="text" id="share-link-input" readonly onclick="this.select()">
          <button class="btn btn-ghost btn-sm" onclick="copyShareLink()">Copy Link</button>
        </div>
        <div class="result-box-actions">
          <button class="btn btn-primary btn-block" onclick="goToJoinFromHost()">Join this game ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
</div><!-- /screen-host -->


<!-- ============================================================
     JOIN SCREEN
============================================================ -->
<div id="screen-join" class="screen">
  <div class="sub-screen">
    <div class="sub-screen-header">
      <button class="btn btn-ghost btn-sm" onclick="showScreen('landing')">‚Üê Back</button>
      <h2>Join a Game</h2>
    </div>

    <div class="field">
      <label for="gamecode">Game Code</label>
      <input type="text" id="gamecode" placeholder="Enter 10-character code" autocomplete="off" spellcheck="false">
    </div>

    <div>
      <div class="player-selector-label">Player Number</div>
      <div class="team-hint">
        <span><span class="dot dot-even"></span> Even team (1, 3, 5)</span>
        <span><span class="dot dot-odd"></span> Odd team (2, 4, 6)</span>
      </div>
      <div class="player-selector">
        <button class="player-btn active-even" data-player="0" onclick="selectPlayer(this)">1</button>
        <button class="player-btn"             data-player="1" onclick="selectPlayer(this)">2</button>
        <button class="player-btn"             data-player="2" onclick="selectPlayer(this)">3</button>
        <button class="player-btn"             data-player="3" onclick="selectPlayer(this)">4</button>
        <button class="player-btn"             data-player="4" onclick="selectPlayer(this)">5</button>
        <button class="player-btn"             data-player="5" onclick="selectPlayer(this)">6</button>
      </div>
      <!-- Hidden input read by join.js -->
      <input type="hidden" id="player" value="1">
    </div>

    <div class="field" style="margin-top:14px">
      <label for="playername">Your Name</label>
      <input type="text" id="playername" placeholder="Optional display name" autocomplete="off">
    </div>

    <div class="join-actions">
      <button class="btn btn-primary btn-block btn-lg" onclick="join()">Join as Player</button>
      <button class="btn btn-secondary btn-block" onclick="wjoin()">Spectate</button>
      <div class="join-divider">or</div>
      <button class="btn btn-ghost btn-block btn-sm" onclick="leaveGame()">Leave Current Game</button>
    </div>
  </div>
</div><!-- /screen-join -->


<!-- ============================================================
     GAME SCREEN
============================================================ -->
<div id="screen-game" class="screen">

  <!-- Header -->
  <div class="game-header">
    <span class="game-header-logo">üÉè Playfish</span>
    <span id="gameroom" class="game-code-badge" title="Click to copy share link" onclick="copyGameShareLink()"></span>
    <span id="gameplayer" class="game-player-badge"></span>
    <span id="score" class="game-score-badge"></span>
    <span class="game-header-spacer"></span>
    <button class="btn btn-ghost btn-sm" onclick="leaveGame()">Leave</button>
  </div>

  <!-- Players row -->
  <div class="players-row">
    <div class="player-cell team-even" id="pcell-0">
      <div class="player-cell-name" id="table1">P1</div>
      <div class="player-cell-count" id="numcards0">‚Äì</div>
    </div>
    <div class="player-cell team-odd" id="pcell-1">
      <div class="player-cell-name" id="table2">P2</div>
      <div class="player-cell-count" id="numcards1">‚Äì</div>
    </div>
    <div class="player-cell team-even" id="pcell-2">
      <div class="player-cell-name" id="table3">P3</div>
      <div class="player-cell-count" id="numcards2">‚Äì</div>
    </div>
    <div class="player-cell team-odd" id="pcell-3">
      <div class="player-cell-name" id="table4">P4</div>
      <div class="player-cell-count" id="numcards3">‚Äì</div>
    </div>
    <div class="player-cell team-even" id="pcell-4">
      <div class="player-cell-name" id="table5">P5</div>
      <div class="player-cell-count" id="numcards4">‚Äì</div>
    </div>
    <div class="player-cell team-odd" id="pcell-5">
      <div class="player-cell-name" id="table6">P6</div>
      <div class="player-cell-count" id="numcards5">‚Äì</div>
    </div>
  </div>

  <!-- Declared sets bar -->
  <div class="declared-bar">
    <span class="declared-bar-label">Declared:</span>
    <span id="declaredsets-inner"></span>
  </div>

  <!-- Game body -->
  <div class="game-body">
    <div class="game-main">

      <!-- Your cards -->
      <div class="cards-section">
        <div class="section-header">
          <span class="section-label">Your Cards</span>
          <button class="btn btn-ghost btn-sm" id="toggle-card-view" onclick="shrink_enlarge()">Compact</button>
          <button class="btn btn-ghost btn-sm" onclick="refresh()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
          </button>
        </div>
        <div class="cards-wrap">
          <div id="playercards2" class="cards-expanded-inner" style="display:none"></div>
          <div id="playercards2a" class="cards-compact-inner"></div>
        </div>
      </div>

      <!-- Game log -->
      <div class="game-log">
        <span class="log-icon">üìã</span>
        <span id="lastmove">Waiting for game state‚Ä¶</span>
      </div>

      <!-- Actions -->
      <div class="action-area">
        <div class="action-extras">
          <button class="declare-alert-btn" onclick="declarealert()">‚ö†Ô∏è Declare Alert</button>
        </div>

        <div class="action-tabs-bar">
          <button class="action-tab-btn active" data-tab="ask-panel" onclick="switchTab(this)">Ask</button>
          <button class="action-tab-btn" data-tab="declare-panel" onclick="switchTab(this)">Declare</button>
          <button class="action-tab-btn" data-tab="transfer-panel" onclick="switchTab(this)">Transfer</button>
          <button class="action-tab-btn" data-tab="chat-panel" onclick="switchTab(this); resetChatCounter()">
            Chat
            <span class="tab-badge" id="chatbadge" style="display:none"></span>
          </button>
        </div>

        <div class="action-panel-area">

          <!-- ASK -->
          <div id="ask-panel" class="action-panel active">
            <div class="ask-step">
              <div class="ask-step-label">1 ¬∑ Select an opponent</div>
              <div class="ask-opp-btns" id="askplayer2a">
                <button class="ask-opp-btn op1" data-player="-1" onclick="selectAskOpp(this)">‚Äì</button>
                <button class="ask-opp-btn op2" data-player="-1" onclick="selectAskOpp(this)">‚Äì</button>
                <button class="ask-opp-btn op3" data-player="-1" onclick="selectAskOpp(this)">‚Äì</button>
              </div>
            </div>
            <div class="ask-step">
              <div class="ask-step-label">2 ¬∑ Click one of your cards (pick a set)</div>
              <div id="playercards3a" class="ask-cards"></div>
              <div id="playercards3" class="ask-cards" style="display:none"></div>
            </div>
            <div class="ask-step" id="ask-step3" style="display:none">
              <div class="ask-step-label">3 ¬∑ Click the card you want to ask for</div>
              <div id="playercards4" class="ask-cards"></div>
            </div>
            <!-- hidden select for backward compat -->
            <select id="askplayer2" style="display:none">
              <option value="-1" class="op1"></option>
              <option value="-1" class="op2"></option>
              <option value="-1" class="op3"></option>
            </select>
          </div>

          <!-- DECLARE -->
          <div id="declare-panel" class="action-panel">
            <div class="declare-set-row">
              <select id="declareSET" onchange="updateDeclareDragUI()">
                <option value="-1">‚Äî Select a set ‚Äî</option>
                <option value="0">High Clubs (9‚ÄìA‚ô£)</option>
                <option value="7">Low Clubs (2‚Äì7‚ô£)</option>
                <option value="6">High Hearts (9‚ÄìA‚ô•)</option>
                <option value="1">Low Hearts (2‚Äì7‚ô•)</option>
                <option value="4">High Spades (9‚ÄìA‚ô†)</option>
                <option value="3">Low Spades (2‚Äì7‚ô†)</option>
                <option value="2">High Diamonds (9‚ÄìA‚ô¶)</option>
                <option value="5">Low Diamonds (2‚Äì7‚ô¶)</option>
                <option value="8">Jokers &amp; Eights</option>
              </select>
            </div>
            <div class="declare-unassigned-label">Unassigned ‚Äî drag to a player below</div>
            <div id="declare-unassigned" class="declare-zone"></div>
            <div class="declare-columns">
              <div>
                <div class="declare-col-header" id="declare2player1">Player 1</div>
                <div id="declarebox1" class="declare-zone" data-player="-1"></div>
              </div>
              <div>
                <div class="declare-col-header" id="declare2player2">Player 3</div>
                <div id="declarebox2" class="declare-zone" data-player="-1"></div>
              </div>
              <div>
                <div class="declare-col-header" id="declare2player3">Player 5</div>
                <div id="declarebox3" class="declare-zone" data-player="-1"></div>
              </div>
            </div>
            <div style="margin-top:12px">
              <button class="btn btn-primary" onclick="declare()">Submit Declaration</button>
            </div>
          </div>

          <!-- TRANSFER -->
          <div id="transfer-panel" class="action-panel">
            <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Pass your turn to a teammate:</p>
            <div class="transfer-btns" id="transfer-buttons">
              <button class="transfer-btn op1" data-player="-1" onclick="transfer(parseInt(this.dataset.player))">‚Äì</button>
              <button class="transfer-btn op2" data-player="-1" onclick="transfer(parseInt(this.dataset.player))">‚Äì</button>
            </div>
            <!-- hidden select for backward compat -->
            <select id="transfer" style="display:none" class="playerselectmenu2">
              <option value="-1" class="op1"></option>
              <option value="-1" class="op2"></option>
            </select>
          </div>

          <!-- CHAT -->
          <div id="chat-panel" class="action-panel">
            <div id="message-container" class="chat-log"></div>
            <div class="chat-input-row">
              <input type="text" id="chatMessage" placeholder="Message‚Ä¶">
              <button class="btn btn-primary btn-sm" id="sendmessagebutton" onclick="sendMessage()">Send</button>
            </div>
          </div>

        </div><!-- /action-panel-area -->
      </div><!-- /action-area -->

    </div><!-- /game-main -->

    <!-- Sidebar (visible on wide screens) -->
    <aside class="game-sidebar">
      <div class="sidebar-section">
        <div class="sidebar-section-label">Declared Sets</div>
        <div id="declaredsets" style="font-size:12px;color:var(--text-muted)">None yet</div>
      </div>
      <div class="sidebar-chat">
        <div class="sidebar-chat-label">Chat</div>
        <div id="sidebar-message-container" class="sidebar-chat-log"></div>
        <div class="sidebar-chat-input">
          <input type="text" id="sidebar-chatMessage" placeholder="Message‚Ä¶">
          <button class="btn btn-primary btn-icon btn-sm" onclick="sendSidebarMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>
    </aside>

  </div><!-- /game-body -->
</div><!-- /screen-game -->

<!-- ============================================================
     TOAST
============================================================ -->
<div id="toast"></div>

<!-- Audio -->
<audio id="notification-sound" style="display:none">
  <source src="definite.mp3" type="audio/mpeg">
</audio>

<!-- ============================================================
     CORE SCRIPTS (inline)
============================================================ -->
<script>
/* ‚îÄ‚îÄ Client ID cookie ‚îÄ‚îÄ */
(function ensureClientId() {
  if (!document.cookie.split(';').some(c => c.trim().startsWith('clientid='))) {
    const id = Array.from(crypto.getRandomValues(new Uint8Array(16)))
      .map(b => b.toString(16).padStart(2, '0')).join('');
    const secure = location.protocol === 'https:' ? '; Secure' : '';
    document.cookie = 'clientid=' + id + '; path=/; SameSite=Strict' + secure;
  }
})();

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
let _toastTimer = null;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('visible');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('visible'), 3200);
}

/* ‚îÄ‚îÄ Screen switching ‚îÄ‚îÄ */
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const s = document.getElementById('screen-' + name);
  if (s) s.classList.add('active');
}

/* ‚îÄ‚îÄ Action tab switching ‚îÄ‚îÄ */
function switchTab(btn) {
  const panelId = btn.dataset.tab;
  document.querySelectorAll('.action-tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.action-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  const panel = document.getElementById(panelId);
  if (panel) panel.classList.add('active');
}

/* ‚îÄ‚îÄ Player selector (join screen) ‚îÄ‚îÄ */
function selectPlayer(btn) {
  document.querySelectorAll('.player-btn').forEach(b => {
    b.className = 'player-btn';
  });
  const idx = parseInt(btn.dataset.player); // 0-based
  // game.ts: indices 0,2,4 = even game team (scoreEven); indices 1,3,5 = odd game team (scoreOdd)
  btn.className = 'player-btn ' + (idx % 2 === 0 ? 'active-even' : 'active-odd');
  document.getElementById('player').value = idx + 1; // 1-based for join.js
}

/* ‚îÄ‚îÄ Ask opponent selection ‚îÄ‚îÄ */
let selectedAskOpponent = -1;
function selectAskOpp(btn) {
  document.querySelectorAll('.ask-opp-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedAskOpponent = parseInt(btn.dataset.player);
  // Also update hidden select for compat
  const sel = document.getElementById('askplayer2');
  if (sel) {
    const idx = Array.from(document.querySelectorAll('.ask-opp-btn')).indexOf(btn);
    sel.selectedIndex = idx;
  }
}

/* ‚îÄ‚îÄ Copy utilities ‚îÄ‚îÄ */
function copyText(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => showToast('Copied!'));
  } else {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('Copied!');
  }
}
function copyCode() {
  const code = document.getElementById('code').value;
  if (code) copyText(code);
}
function copyShareLink() {
  const link = document.getElementById('share-link-input').value;
  if (link) copyText(link);
}
function copyGameShareLink() {
  const code = document.getElementById('gameroom').textContent;
  if (code) copyText(location.origin + location.pathname + '?gamecode=' + code);
}

/* ‚îÄ‚îÄ After host creates game, fill in code+link and jump to join ‚îÄ‚îÄ */
function goToJoinFromHost() {
  const code = document.getElementById('code').value;
  if (code) {
    document.getElementById('gamecode').value = code;
    history.replaceState(null, '', '?gamecode=' + code);
  }
  showScreen('join');
}

/* ‚îÄ‚îÄ Banner: join from URL param ‚îÄ‚îÄ */
function joinFromBanner() {
  const code = document.getElementById('banner-code').textContent.trim();
  document.getElementById('gamecode').value = code;
  showScreen('join');
}

/* ‚îÄ‚îÄ Page load: check for ?gamecode= ‚îÄ‚îÄ */
(function checkUrlGameCode() {
  const params = new URLSearchParams(location.search);
  const code = params.get('gamecode');
  if (code) {
    document.getElementById('banner-code').textContent = code;
    document.getElementById('gamecode-banner').style.display = 'flex';
    document.getElementById('gamecode').value = code;
  }
})();

/* ‚îÄ‚îÄ Show game screen + request state ‚îÄ‚îÄ */
function showGameScreen() {
  showScreen('game');
  socket.emit('gamestate', '');
}

/* ‚îÄ‚îÄ GameSocket: drop-in Socket.io replacement using native WebSocket ‚îÄ‚îÄ */
class GameSocket {
  constructor() {
    this._ws = null;
    this._handlers = {};
    this._pendingMessages = [];
  }
  connect(gameCode, onOpen) {
    if (this._ws) {
      this._ws.onclose = null;
      this._ws.close();
    }
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(proto + '://' + location.host + '/ws?game=' + encodeURIComponent(gameCode));
    this._ws = ws;
    ws.onopen = () => {
      while (this._pendingMessages.length > 0) ws.send(this._pendingMessages.shift());
      if (onOpen) onOpen();
    };
    ws.onmessage = (ev) => {
      let msg;
      try { msg = JSON.parse(ev.data); } catch(e) { return; }
      const { event, ...rest } = msg;
      const handlers = this._handlers[event] || [];
      const dataStr = JSON.stringify(rest);
      handlers.forEach(h => h(dataStr));
    };
    ws.onclose = () => {};
    ws.onerror = (err) => console.error('WebSocket error', err);
  }
  on(event, handler) {
    if (!this._handlers[event]) this._handlers[event] = [];
    this._handlers[event].push(handler);
  }
  emit(event, dataStr) {
    let extra = {};
    if (dataStr && dataStr !== '') { try { extra = JSON.parse(dataStr); } catch(e) {} }
    const payload = JSON.stringify(Object.assign({ event }, extra));
    if (this._ws && this._ws.readyState === WebSocket.OPEN) {
      this._ws.send(payload);
    } else {
      this._pendingMessages.push(payload);
    }
  }
}
const socket = new GameSocket();

/* ‚îÄ‚îÄ Sortable.js for declare drag-and-drop ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', function() {
  const sortableOpts = { group: { name: 'declare' }, animation: 120, draggable: '.declare-chip' };
  new Sortable(document.getElementById('declare-unassigned'), sortableOpts);
  new Sortable(document.getElementById('declarebox1'), sortableOpts);
  new Sortable(document.getElementById('declarebox2'), sortableOpts);
  new Sortable(document.getElementById('declarebox3'), sortableOpts);

  // Enter key ‚Üí send chat
  document.getElementById('chatMessage').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
  });
  document.getElementById('sidebar-chatMessage').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); sendSidebarMessage(); }
  });
});
</script>

<script src="scripts/host.js"></script>
<script src="scripts/join.js"></script>
<script src="scripts/app.js"></script>
<script src="scripts/localchat.js"></script>

</body>
</html>
